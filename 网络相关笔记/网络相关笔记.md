# 网络层协议
## 地址解析协议（ARP）
### ARP解析过程
网络上的通信会使用到逻辑地址和物理地址。逻辑地址允许不同网络以及间接相连的设备之间相互通信，物理地址则用于同一网段中直接使用交换机相互连接的设备之间进行的通信。在大多数情况下，正常通信需要这两种地址协同工作。

当一个以太帧通过交换机的某个端口传入时，交换机会自动记录下该以太帧的源mac地址与该端口的映射关系。

mac地址的长度为48位(6个字节)，通常表示为12个16进制数，如：00-16-EA-AE-3C-40就是一个mac地址，其中前3个字节，16进制数00-16-EA代表网络硬件制造商的编号，它由IEEE(电气与电子工程师协会)分配，而后3个字节，16进制数AE-3C-40代表该制造商所制造的某个网络产品(如网卡)的系列号。

ARP协议只有两种类型的数据包：一个ARP请求包与一个ARP响应包。

当一个主机要向局域网内的另一个主机通信但又不知道它的mac地址时，会对该网段内的所有主机广播一个ARP请求包：
![arp请求与响应](arp请求与响应.png)

> 在Windows主机中，可以通过在命令行中键入arp -a来查看ARP表。

### Gratuitous ARP
多数情况下，一个主机的IP是会改变的，而当这种改变发生后，主机缓存的IP与MAC地址的映射关系就失效了。为了防止造成通信错误，Gratuitous ARP请求会被发送到网络中，强制所有收到它的设备去用新的IP和MAC地址映射更新缓存：
![gratuitous arp](gratuitous-arp.png)

## 互联网协议
### IPv4
IPv4地址是一个32位的地址，用来唯一标识连接到网络的设备。

每个IP地址都包含着两个部分：网络地址和主机地址。网络地址用来标识设备所连接到的局域网，而主机地址则标识这个网络中的主机本身。

为简便起见，IP地址和网络掩码通常会被写成无类型域间选路（Classless Inter-Domain Routing，CIDR）的形式。在这个形式下，一个完整的IP地址后面会跟有一个左斜杠（/），斜杠右边的数字表示网络部分的位数。举例来说，IP地址10.10.1.22和网络掩码255.255.0.0，在CIDR表示法下就会被写成10.10.1.22/16的形式。

TTL是一个IP包所能够经过的最大路由器数目，TTL在数据包被创建时就会被定义，而且通常在每次被发往一个路由器的时候减1：
![TTL](IP-TTL.png)

以太网的默认MTU是1500，也就是说以太网的网络上所能传输的最大报文大小是1500字节（并不包括14字节的以太网头本身）。

当一个设备准备传输一个IP数据包时，它将会比较这个数据包的大小，以及将要把这个数据包传送出去的网络接口MTU，用以决定是否需要将这个数据包分片。如果数据包大小大于MTU，那么这个数据包就会被分片。

当一个IP包要分片时，会按如下步骤进行：
1. 设备将数据分为若干个将要接下来进行传输的数据包。
2. 设置每个IP分片相同的标识符。
3. 每个IP头的总长度字段会被设置为每个分片的片段长度。
4. 除了最后一个分片数据包外，之前所有分片数据包的标志位都被标识为1。
5. 设置每个IP分片的分片偏移。
6. 发送分片。